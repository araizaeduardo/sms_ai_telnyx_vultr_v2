<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Cliente</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .detail-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .detail-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .status-Pendiente { background: #cfe2ff; }
        .status-EnProceso { background: #fff3cd; }
        .status-EnRevision { background: #e2d9f3; }
        .status-Completado { background: #d1e7dd; }

        .detail-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .detail-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .message-content {
            white-space: pre-wrap;
            background: white;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            margin-top: 0.5rem;
        }

        .conversation-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
        }

        .message-bubble {
            max-width: 80%;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .message-nuevo {
            background-color: #fff3cd !important; /* Amarillo claro */
            border: 1px solid #ffeeba;
        }

        .message-leido {
            background-color: #d4edda !important; /* Verde claro */
            border: 1px solid #c3e6cb;
        }

        .message-cliente {
            background: #e3f2fd;
            margin-right: auto;
        }

        .message-respuesta {
            background: #f5f5f5;
            margin-left: auto;
        }

        .metadata {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        .message-container {
            position: relative;
        }

        .message-controls {
            padding-top: 0.5rem;
        }

        .message-notes {
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .message-notes:hover {
            opacity: 1;
        }

        .message-content-wrapper {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="detail-card">
            <div class="detail-header d-flex justify-content-between align-items-center">
                <h2>Detalle del Cliente #{{ cliente[0] }}</h2>
                <span class="status-badge status-{{ cliente[6]|replace(' ', '') }}">{{ cliente[6] }}</span>
            </div>

            <!-- Información básica -->
            <div class="row">
                <div class="col-md-6">
                    <div class="detail-section">
                        <div class="detail-label">Nombre</div>
                        <div>{{ cliente[1] or 'No especificado' }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="detail-section">
                        <div class="detail-label">Teléfono</div>
                        <div>📱 {{ cliente[2] }}</div>
                    </div>
                </div>
            </div>

            <!-- Conversación -->
            <div class="conversation-section">
                <h4 class="mb-4">Conversación</h4>
                
                <!-- Mensaje del cliente -->
                <div class="message-bubble message-cliente">
                    <div class="detail-label">Mensaje del Cliente</div>
                    <div class="message-content">{{ cliente[3] }}</div>
                    <div class="metadata">
                        Recibido: {{ cliente[5] }}
                    </div>
                </div>

                <!-- Respuesta del sistema -->
                {% if cliente[4] %}
                <div class="message-bubble message-respuesta">
                    <div class="detail-label">Respuesta del Sistema</div>
                    <div class="message-content">{{ cliente[4] }}</div>
                    <div class="metadata">
                        Enviado: {{ cliente[5] }}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Historial de Mensajes -->
            <div class="conversation-section">
                <h4 class="mb-4">Historial de Mensajes</h4>
                {% for fecha, mensajes in historial_agrupado.items() %}
                    <div class="date-group mb-4">
                        <h5 class="date-header">{{ fecha }}</h5>
                        {% for mensaje in mensajes %}
                            <div class="message-container d-flex align-items-start gap-2 mb-3">
                                <div class="message-controls">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               id="check-{{ mensaje.id }}"
                                               {% if mensaje.estado and mensaje.estado != 0 %}checked{% endif %}
                                               onchange="actualizarEstadoMensaje(this, {{ mensaje.id }})">
                                    </div>
                                </div>
                                <div class="message-content-wrapper flex-grow-1">
                                    <div class="message-bubble {% if mensaje.tipo == 'enviado' %}message-respuesta{% else %}message-cliente{% endif %} {% if not mensaje.estado or mensaje.estado == 0 %}message-nuevo{% else %}message-leido{% endif %}"
                                         id="mensaje-{{ mensaje.id }}">
                                        <div class="message-content">{{ mensaje.mensaje }}</div>
                                        <div class="metadata">
                                            {{ mensaje.hora }}
                                            {% if not mensaje.estado or mensaje.estado == 0 %}
                                                <span class="badge bg-warning">Nuevo</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="message-notes mt-2">
                                        <input type="text" class="form-control form-control-sm" 
                                               placeholder="Agregar nota..."
                                               value="{{ mensaje.nota or '' }}"
                                               onchange="guardarNota(this, {{ mensaje.id }})">
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

            <!-- Botones de acción -->
            <div class="mt-4 d-flex gap-2">
                <a href="/kanban" class="btn btn-secondary">Volver al Tablero</a>
                <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#smsModal">
                    <i class="bi bi-chat-dots"></i> Enviar SMS
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para SMS -->
    <div class="modal fade" id="smsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enviar SMS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="mensajeSMS" class="form-label">Mensaje:</label>
                        <textarea class="form-control" id="mensajeSMS" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="enviarSMS('{{ cliente[2] }}')">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agregar Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function enviarSMS(telefono) {
            const mensaje = document.getElementById('mensajeSMS').value;
            fetch('/enviar-sms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    telefono: telefono,
                    mensaje: mensaje,
                    cliente_id: {{ cliente[0] }}
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Mensaje enviado correctamente');
                    location.reload();
                } else {
                    alert('Error al enviar el mensaje: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error al enviar el mensaje: ' + error);
            });
        }

        function actualizarEstadoMensaje(checkbox, mensajeId) {
            const mensajeBubble = document.getElementById(`mensaje-${mensajeId}`);
            
            fetch('/actualizar-estado-mensaje', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    mensaje_id: mensajeId,
                    estado: checkbox.checked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (checkbox.checked) {
                        mensajeBubble.classList.remove('message-nuevo');
                        mensajeBubble.classList.add('message-leido');
                    } else {
                        mensajeBubble.classList.remove('message-leido');
                        mensajeBubble.classList.add('message-nuevo');
                    }
                } else {
                    alert('Error al actualizar el estado del mensaje');
                    checkbox.checked = !checkbox.checked;
                }
            })
            .catch(error => {
                alert('Error: ' + error);
                checkbox.checked = !checkbox.checked;
            });
        }

        function guardarNota(input, mensajeId) {
            fetch('/guardar-nota-mensaje', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    mensaje_id: mensajeId,
                    nota: input.value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar indicador de éxito
                    input.style.backgroundColor = '#e8f5e9';
                    setTimeout(() => {
                        input.style.backgroundColor = '';
                    }, 1000);
                } else {
                    alert('Error al guardar la nota');
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }

        // Función para verificar actualizaciones
        function verificarActualizaciones() {
            fetch('/check-new-messages')
            .then(response => response.json())
            .then(data => {
                if (data.nuevos_mensajes && data.nuevos_mensajes.includes({{ cliente[0] }})) {
                    // Guardar el estado solo de los checkboxes existentes (no nuevos)
                    const estadosCheckboxes = {};
                    document.querySelectorAll('.form-check-input').forEach(checkbox => {
                        const mensajeId = checkbox.id.replace('check-', '');
                        const mensajeBubble = document.getElementById(`mensaje-${mensajeId}`);
                        // Solo guardar estado si el mensaje no es nuevo
                        if (!mensajeBubble.classList.contains('message-nuevo')) {
                            estadosCheckboxes[checkbox.id] = checkbox.checked;
                        }
                    });
                    
                    // Guardar en sessionStorage
                    sessionStorage.setItem('checkboxStates', JSON.stringify(estadosCheckboxes));
                    
                    // Recargar la página
                    location.reload();
                }
            })
            .catch(error => console.error('Error verificando actualizaciones:', error));
        }

        // Modificar la función de restauración de estados
        document.addEventListener('DOMContentLoaded', () => {
            const savedStates = sessionStorage.getItem('checkboxStates');
            if (savedStates) {
                const estados = JSON.parse(savedStates);
                Object.entries(estados).forEach(([id, checked]) => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        const mensajeId = id.replace('check-', '');
                        const mensajeBubble = document.getElementById(`mensaje-${mensajeId}`);
                        
                        // Solo restaurar el estado si el mensaje no es nuevo
                        if (mensajeBubble && !mensajeBubble.classList.contains('message-nuevo')) {
                            checkbox.checked = checked;
                            if (checked) {
                                mensajeBubble.classList.remove('message-nuevo');
                                mensajeBubble.classList.add('message-leido');
                            } else {
                                mensajeBubble.classList.remove('message-leido');
                                mensajeBubble.classList.add('message-nuevo');
                            }
                        }
                    }
                });
                // Limpiar el storage después de restaurar
                sessionStorage.removeItem('checkboxStates');
            }
        });

        // Función para mantener viva la sesión
        function keepAlive() {
            fetch('/last_update')
            .then(response => response.json())
            .then(data => {
                // Solo para mantener la conexión activa
                console.log('Conexión activa');
            })
            .catch(error => console.error('Error en keep-alive:', error));
        }

        // Configurar intervalos de actualización
        const INTERVALO_VERIFICACION = 30000; // 30 segundos
        const INTERVALO_KEEP_ALIVE = 240000;  // 4 minutos

        // Iniciar los intervalos cuando la página está visible
        let verificacionInterval = null;
        let keepAliveInterval = null;

        function iniciarIntervalos() {
            verificacionInterval = setInterval(verificarActualizaciones, INTERVALO_VERIFICACION);
            keepAliveInterval = setInterval(keepAlive, INTERVALO_KEEP_ALIVE);
        }

        function detenerIntervalos() {
            if (verificacionInterval) clearInterval(verificacionInterval);
            if (keepAliveInterval) clearInterval(keepAliveInterval);
        }

        // Manejar visibilidad de la página
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                detenerIntervalos();
            } else {
                iniciarIntervalos();
                // Verificar inmediatamente al volver a la página
                verificarActualizaciones();
            }
        });

        // Iniciar intervalos cuando la página carga
        iniciarIntervalos();

        // Agregar indicador visual de actualización
        const statusIndicator = document.createElement('div');
        statusIndicator.style.position = 'fixed';
        statusIndicator.style.bottom = '10px';
        statusIndicator.style.right = '10px';
        statusIndicator.style.padding = '5px 10px';
        statusIndicator.style.borderRadius = '5px';
        statusIndicator.style.fontSize = '12px';
        statusIndicator.style.opacity = '0.7';
        statusIndicator.style.backgroundColor = '#28a745';
        statusIndicator.style.color = 'white';
        statusIndicator.textContent = 'Actualización automática activada';
        document.body.appendChild(statusIndicator);

        // Mostrar última actualización
        const lastUpdateIndicator = document.createElement('div');
        lastUpdateIndicator.style.position = 'fixed';
        lastUpdateIndicator.style.bottom = '35px';
        lastUpdateIndicator.style.right = '10px';
        lastUpdateIndicator.style.padding = '5px 10px';
        lastUpdateIndicator.style.borderRadius = '5px';
        lastUpdateIndicator.style.fontSize = '12px';
        lastUpdateIndicator.style.opacity = '0.7';
        lastUpdateIndicator.style.backgroundColor = '#6c757d';
        lastUpdateIndicator.style.color = 'white';
        document.body.appendChild(lastUpdateIndicator);

        function actualizarIndicadorTiempo() {
            const ahora = new Date();
            lastUpdateIndicator.textContent = `Última verificación: ${ahora.toLocaleTimeString()}`;
        }

        // Actualizar el indicador de tiempo cada vez que se verifica
        const verificacionOriginal = verificarActualizaciones;
        verificarActualizaciones = function() {
            verificacionOriginal();
            actualizarIndicadorTiempo();
        };

        // Mostrar tiempo inicial
        actualizarIndicadorTiempo();
    </script>
</body>
</html> 